- name: Create dir for knowage
  file: 
    state: directory
    path: "{{item}}"
  loop: 
    - /data/wwwroot/knowage
    - /data/db/mariadb
    - /data/tomcat
    
- name: Clone knowage in Websoft9 
  git:
    repo: "{{knowage_git_url}}"
    dest: "/data/wwwroot/knowage"
    version: dev

- name: Run docker-compose 
  shell: | 
    docker-compose up -d
    sleep 30
  args:
    chdir: /data/wwwroot/knowage/knowage-server

- name: Set soft link for knowage
  file:
    src: '{{item.src}}'
    dest: '{{item.dest}}'
    state: link
    force: yes
  with_items:
  - {src: /data/wwwroot/knowage/knowage-server/db/,dest: /data/db/mariadb/db}
  - {src: /data/wwwroot/knowage/knowage-server/cache/,dest: /data/db/mariadb/db/cache}
  - {src: /data/wwwroot/knowage/knowage-server/apache-tomcat/,dest: /data/tomcat}

# check service and version
- name: Check redmine service 
  shell: echo "knowage" `docker inspect knowage |grep -i status`
  register: check_knowage_service
  notify: check_knowage_service
    
- name: Check knowage version
  shell: >
    sudo echo "knowage version:" $(docker images |grep knowagelabs |awk '{print $2}' |head -1 |cut -d- -f1) |sudo tee -a /data/logs/install_version.txt  

- name: Check mariadb version
  shell: >
    sudo echo "mariadb version:" $(docker images |grep mariadb |awk '{print $2}') |sudo tee -a /data/logs/install_version.txt  